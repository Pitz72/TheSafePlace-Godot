# Appendice F: Database degli Eventi Narrativi

Questo documento contiene la trascrizione completa dell'array `LORE_EVENTS_LINEAR` dal file `lore_events_linear.js`. Questi eventi costituiscono la spina dorsale della trama principale, "Ultimo's Journey".

## 1. Eventi Narrativi (`LORE_EVENTS_LINEAR`)

```javascript
const LORE_EVENTS_LINEAR = [
    {
        id: "lore_echo_of_departure",
        title: "L'Eco della Partenza",
        description: "Nel rifugio che è stato la tua casa, trovi la lettera che tuo padre ha lasciato per te. La sua calligrafia tremante rivela l'urgenza: 'Ultimo, figlio mio... se stai leggendo queste parole, significa che non sono tornato in tempo. Il Safe Place esiste, l'ho visto nelle mappe militari prima che tutto crollasse. È la nostra unica speranza. Vai verso est, sempre verso est. Ti aspetterò là, o almeno ci proverò. Le scorte che ti ho lasciato stanno per finire. Devi partire. Sii forte, come ti ho insegnato. Con tutto l'amore che un padre può dare, Marcus.'",
        trigger: {
            type: "days_survived",
            value: 1,
            operator: ">="
        },
        choices: [
            {
                text: "Raccogli le tue cose e parti subito",
                outcome: "Non c'è tempo da perdere. Prepari lo zaino con le ultime provviste e ti avvii verso l'ignoto. Il viaggio inizia ora.",
                effects: [
                    { type: "add_stat", stat: "agilita", value: 1 },
                    { type: "add_lore_flag", flag: "mission_accepted" },
                    { type: "add_lore_flag", flag: "hasty_departure" }
                ]
            },
            {
                text: "Cerca altri indizi nel rifugio",
                outcome: "Prima di partire, frugi tra le cose di tuo padre. Trovi una vecchia mappa militare segnata e alcune note sui pericoli del viaggio.",
                effects: [
                    { type: "add_stat", stat: "percezione", value: 1 },
                    { type: "add_item", item: "old_military_map", quantity: 1 },
                    { type: "add_lore_flag", flag: "mission_accepted" },
                    { type: "add_lore_flag", flag: "careful_preparation" }
                ]
            },
            {
                text: "Medita sulle parole di tuo padre",
                outcome: "Ti siedi un momento a riflettere. I suoi insegnamenti risuonano nella tua mente. Ogni lezione di sopravvivenza torna vivida. Sei pronto.",
                effects: [
                    { type: "add_stat", stat: "adattamento", value: 1 },
                    { type: "add_resource", resource: "experience", value: 5 },
                    { type: "add_lore_flag", flag: "mission_accepted" },
                    { type: "add_lore_flag", flag: "thoughtful_start" }
                ]
            }
        ],
        unique: true,
        priority: 10
    },
    
    {
        id: "lore_first_trial_alone",
        title: "La Prima Prova da Solo",
        description: "La notte cade e sei completamente solo per la prima volta. Il freddo morde, la fame graffia, e ogni rumore nell'oscurità potrebbe essere la tua fine. Questa è la realtà che dovrai affrontare ogni giorno.",
        trigger: {
            type: "condition",
            condition: "first_night_survived",
            requiresFlags: ["mission_accepted"]
        },
        choices: [
            {
                text: "Impara dai tuoi errori",
                outcome: "Ogni difficoltà è una lezione. Domani sarai più forte.",
                effects: [
                    { type: "add_resource", resource: "experience", value: 10 },
                    { type: "add_lore_flag", flag: "learned_survival" }
                ]
            },
            {
                text: "Rimpiangere il passato",
                outcome: "I ricordi del mondo perduto sono dolci e amari insieme.",
                effects: [
                    { type: "add_stat", stat: "percezione", value: 1 },
                    { type: "add_lore_flag", flag: "nostalgic" }
                ]
            }
        ],
        unique: true,
        priority: 9
    },
    
    {
        id: "lore_whispers_from_past",
        title: "Sussurri dal Passato",
        description: "In una casa abbandonata, nascosto sotto le assi del pavimento, trovi un piccolo carillon. È identico a quello che tua madre Lena ti regalò per il tuo decimo compleanno. Quando lo apri, la melodia familiare riempie l'aria, e per un momento il mondo torna com'era.",
        trigger: {
            type: "distance_from_safe_place",
            value: 150,
            operator: "<="
        },
        requiresFlags: ["learned_survival"],
        choices: [
            {
                text: "Conserva il carillon come ricordo",
                outcome: "Lo stringi al petto. Alcuni ricordi valgono più del cibo o dell'acqua.",
                effects: [
                    { type: "add_item", item: "carillon_of_lena", quantity: 1 },
                    { type: "add_stat", stat: "carisma", value: 2 },
                    { type: "add_lore_flag", flag: "has_mothers_memory" }
                ]
            }
        ],
        unique: true,
        priority: 8
    },
    
    {
        id: "lore_shadow_of_others",
        title: "L'Ombra degli Altri",
        description: "Un gruppo di sopravvissuti ti circonda. Si fanno chiamare 'I Corvi' e vogliono tutto quello che hai. Ma il loro capo ti guarda strano quando vede il carillon. 'Lena...', sussurra. 'Conoscevo una donna con quel nome. Cantava questa melodia ai suoi figli prima della Guerra.'",
        trigger: {
            type: "days_survived",
            value: 7,
            operator: ">="
        },
        requiresFlags: ["has_mothers_memory"],
        choices: [
            {
                text: "Chiedi del passato di tua madre",
                outcome: "Il capo dei Corvi abbassa le armi. 'Sei il figlio di Lena... Vai, ragazzo. Il tuo viaggio è più importante del nostro bottino.'",
                effects: [
                    { type: "add_lore_flag", flag: "corvi_alliance" },
                    { type: "add_resource", resource: "food", value: 3 },
                    { type: "add_resource", resource: "water", value: 3 }
                ]
            },
            {
                text: "Fuggi senza parlare",
                outcome: "Corri via nella notte. Alcuni misteri è meglio lasciarli sepolti.",
                effects: [
                    { type: "add_stat", stat: "agilita", value: 1 },
                    { type: "add_lore_flag", flag: "corvi_escaped" }
                ]
            }
        ],
        unique: true,
        priority: 7
    },
    
    {
        id: "lore_wanderer_dilemma",
        title: "Il Dilemma del Viandante",
        description: "Incontri una famiglia - padre, madre e una bambina che ti ricorda te stesso anni fa. Sono affamati, assetati, e la bambina è malata. Hanno sentito parlare del Safe Place ma non ce la faranno mai senza aiuto. Ma tu hai appena abbastanza risorse per te stesso.",
        trigger: {
            type: "distance_from_safe_place",
            value: 120,
            operator: "<="
        },
        choices: [
            {
                text: "Condividi le tue risorse",
                outcome: "La gratitudine nei loro occhi vale più di qualsiasi tesoro. La bambina sorride per la prima volta in giorni.",
                effects: [
                    { type: "add_resource", resource: "food", value: -3 },
                    { type: "add_resource", resource: "water", value: -3 },
                    { type: "add_stat", stat: "carisma", value: 3 },
                    { type: "add_lore_flag", flag: "helped_family" }
                ]
            },
            {
                text: "Prosegui da solo",
                outcome: "La sopravvivenza richiede scelte difficili. Ti allontani, cercando di non sentire il pianto della bambina.",
                effects: [
                    { type: "add_stat", stat: "adattamento", value: 2 },
                    { type: "add_lore_flag", flag: "chose_survival" }
                ]
            }
        ],
        unique: true,
        priority: 6
    },
    
    {
        id: "lore_echoes_of_inexpressed_war",
        title: "Echi della Guerra Inespressa",
        description: "In un bunker militare abbandonato, trovi documenti classificati. La Guerra Inespressa non fu una guerra normale - fu un esperimento andato male. 'Progetto Chimera: alterazione della realtà su scala continentale'. Tuo padre lavorava al progetto. Il Safe Place era il bunker di emergenza per gli scienziati.",
        trigger: {
            type: "days_survived",
            value: 15,
            operator: ">="
        },
        choices: [
            {
                text: "Studia i documenti",
                outcome: "La verità è terrificante ma necessaria. Ora capisci perché tuo padre doveva raggiungere il Safe Place.",
                effects: [
                    { type: "add_item", item: "classified_documents", quantity: 1 },
                    { type: "add_stat", stat: "percezione", value: 2 },
                    { type: "add_lore_flag", flag: "knows_truth" }
                ]
            }
        ],
        unique: true,
        priority: 5
    },
    
    {
        id: "lore_dream_of_green_valley",
        title: "Il Sogno della Valle Verde",
        description: "La febbre ti prende dopo giorni di pioggia. Nel delirio, sogni una valle verde protetta dalle montagne, dove il grano cresce alto e l'acqua scorre pulita. Vedi tuo padre che ti aspetta vicino a una quercia centenaria. 'Non mollare, Ultimo. Siamo così vicini.'",
        trigger: {
            type: "condition",
            condition: "player_sick",
            additionalCheck: "distance_from_safe_place <= 80"
        },
        choices: [
            {
                text: "Trova la forza di continuare",
                outcome: "Il sogno ti dà speranza. La febbre passa e ti alzi più determinato che mai.",
                effects: [
                    { type: "cure_status", status: "isSick" },
                    { type: "add_resource", resource: "hp", value: 20 },
                    { type: "add_lore_flag", flag: "prophetic_dream" }
                ]
            }
        ],
        unique: true,
        priority: 4
    },
    
    {
        id: "lore_radio_interception",
        title: "L'Intercettazione Radio",
        description: "Una vecchia radio militare crepita alla vita. '...a tutti i sopravvissuti del Progetto Chimera... il Safe Place è operativo... coordinate confermate... il Guardiano vi aspetta... ripeto, il protocollo Angelo è attivo...' La trasmissione si ripete. È registrata, ma quanto è vecchia?",
        trigger: {
            type: "distance_from_safe_place",
            value: 50,
            operator: "<="
        },
        requiresFlags: ["knows_truth"],
        choices: [
            {
                text: "Memorizza le coordinate",
                outcome: "Le coordinate confermano che sei sulla strada giusta. Il Safe Place è reale e vicino.",
                effects: [
                    { type: "reveal_map_area", radius: 10 },
                    { type: "add_lore_flag", flag: "has_coordinates" }
                ]
            }
        ],
        unique: true,
        priority: 3
    },
    
    {
        id: "lore_guardian_of_threshold",
        title: "Il Guardiano della Soglia",
        description: "Alle pendici delle montagne, un uomo in armatura da combattimento ti blocca la strada. 'Fermo. Io sono il Guardiano. Il Safe Place non è un rifugio per tutti. Solo coloro che sono degni possono entrare. Mostrami chi sei diventato, Ultimo.' È Marcus, tuo padre. È cambiato, più duro, ma i suoi occhi sono gli stessi.",
        trigger: {
            type: "location",
            location: { x: 180, y: 180 }
        },
        requiresFlags: ["has_coordinates"],
        choices: [
            {
                text: "Parla della famiglia che hai aiutato (se l'hai fatto)",
                condition: "has_lore_flag('helped_family')",
                outcome: "Quando parli della famiglia, un lampo di umanità attraversa gli occhi di tuo padre. 'Hai mantenuto il tuo cuore. Questo è ciò che conta.' Abbassa l'arma.",
                effects: [
                    { type: "add_lore_flag", flag: "passed_guardians_test" }
                ]
            },
            {
                text: "Mostra il carillon di tua madre (se ce l'hai)",
                condition: "has_item('carillon_of_lena')",
                outcome: "Mostri il carillon. Tuo padre lo guarda, e per un attimo il Guardiano scompare. 'Lena... non l'ho mai dimenticata.' Ti fa passare.",
                effects: [
                    { type: "add_lore_flag", flag: "passed_guardians_test" }
                ]
            },
            {
                text: "Combatti per il tuo diritto di entrare",
                outcome: "La lotta è brutale, ma alla fine riesci a disarmarlo. 'Sei diventato forte', dice con rispetto. 'Forse anche troppo. Entra.'",
                effects: [
                    { type: "add_resource", resource: "experience", value: 100 },
                    { type: "add_lore_flag", flag: "passed_guardians_test" }
                ]
            }
        ],
        unique: true,
        priority: 2
    },
    
    {
        id: "lore_the_safe_place",
        title: "The Safe Place",
        description: "Varchi la soglia. Non è una valle verde, ma un bunker high-tech, pulito e funzionante. L'aria è filtrata, il cibo cresce nei laboratori idroponici. Ci sono altri scienziati, altre famiglie. Tuo padre ti mette una mano sulla spalla. 'Benvenuto a casa, Ultimo. Il mondo là fuori è perduto, ma qui... qui possiamo ricostruire. Questo è il nostro fardello e la nostra speranza.'",
        trigger: {
            type: "location",
            location: { x: 200, y: 200 }
        },
        requiresFlags: ["passed_guardians_test"],
        choices: [
            {
                text: "Abbraccia il tuo nuovo futuro",
                outcome: "Il viaggio è finito. Una nuova vita inizia. Hai trovato il Safe Place.",
                effects: [
                    { type: "end_game", ending: "the_survivor" }
                ]
            }
        ],
        unique: true,
        priority: 1
    }
];
```

## 2. Logica di Supporto (per contesto)

```javascript
// Funzione per controllare se un evento può essere attivato
function canTriggerLoreEvent(eventId, playerState) {
    const event = LORE_EVENTS_LINEAR.find(e => e.id === eventId);
    if (!event || playerState.triggeredLoreEvents.includes(eventId)) {
        return false;
    }

    // Controlla trigger
    const trigger = event.trigger;
    let triggerMet = false;
    switch (trigger.type) {
        case 'days_survived':
            triggerMet = evaluateCondition(playerState.days, trigger.value, trigger.operator);
            break;
        case 'distance_from_safe_place':
            const distance = calculateDistanceFromSafePlace(playerState.x, playerState.y);
            triggerMet = evaluateCondition(distance, trigger.value, trigger.operator);
            break;
        case 'condition':
            triggerMet = evaluateSpecialCondition(trigger.condition, playerState, trigger.additionalCheck);
            break;
        case 'location':
            triggerMet = isAtLocation(playerState.x, playerState.y, trigger.location);
            break;
    }

    if (!triggerMet) return false;

    // Controlla flag richiesti
    if (event.requiresFlags) {
        for (const flag of event.requiresFlags) {
            if (!playerState.loreFlags.includes(flag)) {
                return false;
            }
        }
    }

    return true;
}

// Helper per la valutazione delle condizioni
function evaluateCondition(value, target, operator) {
    switch (operator) {
        case '>=': return value >= target;
        case '<=': return value <= target;
        case '==': return value === target;
        default: return false;
    }
}

function calculateDistanceFromSafePlace(x, y) {
    // Coordinate del Safe Place (esempio)
    const safePlaceX = 200;
    const safePlaceY = 200;
    return Math.sqrt(Math.pow(safePlaceX - x, 2) + Math.pow(safePlaceY - y, 2));
}

function evaluateSpecialCondition(condition, playerState, additionalCheck) {
    switch (condition) {
        case 'first_night_survived':
            return playerState.days === 2 && !playerState.isDay;
        case 'player_sick':
            let sickCondition = playerState.isSick || playerState.isPoisoned;
            if (additionalCheck) {
                const parts = additionalCheck.split(' ');
                const distance = calculateDistanceFromSafePlace(playerState.x, playerState.y);
                return sickCondition && evaluateCondition(distance, parseInt(parts[2]), parts[1]);
            }
            return sickCondition;
        default: return false;
    }
}

function isAtLocation(x, y, location) {
    return x === location.x && y === location.y;
}

// Funzione principale per ottenere il prossimo evento lore
function getNextLoreEvent(playerState) {
    for (const event of LORE_EVENTS_LINEAR) {
        if (canTriggerLoreEvent(event.id, playerState)) {
            return event;
        }
    }
    return null; // Nessun evento lore da attivare
}
```

</rewritten_file> 